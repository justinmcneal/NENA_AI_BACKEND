{% extends 'admin/base_site.html' %}

{% block extrahead %}
<style>
    /* Custom styles for dashboard modules and charts */
    .module {
        background-color: #f8f8f8; /* Light background for modules */
        border: 1px solid #e0e0e0; /* Subtle border */
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Soft shadow */
        margin: 0 auto 20px auto; /* Center the module horizontally */
    }

    .module h2 {
        color: black; /* Set h2 text color to black */
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.2em;
    }

    .module p {
        color: black; /* Set p text color to black */
    }

    /* Chart specific styling */
    .chart-container { /* New class for the div wrapping canvas */
        max-width: 600px;
        margin: 0 auto; /* Center the chart within its module */
    }

    canvas {
        background-color: #fff; /* White background for charts */
        border-radius: 3px;
        padding: 10px;
    }

    /* Ensure chart labels are visible on light background */
    .chartjs-render-monitor {
        color: #333; /* Dark text for chart labels */
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <h2>Total Loan Amount</h2>
        <div class="chart-container"><canvas id="totalLoanAmountChart"></canvas></div>
    </div>

    <div class="module">
        <h2>Total Amount Repaid</h2>
        <div class="chart-container"><canvas id="totalAmountRepaidChart"></canvas></div>
    </div>

    <div class="module">
        <h2>Average Monthly Income</h2>
        <div class="chart-container"><canvas id="averageMonthlyIncomeChart"></canvas></div>
    </div>

    <div class="module">
        <h2>Business Consistency Score</h2>
        <div class="chart-container"><canvas id="businessConsistencyScoreChart"></canvas></div>
    </div>

    <div class="module">
        <h2>User Data Table</h2>
        <p>Click <a href="{% url 'admin:users_customuser_changelist' %}">here</a> to view the full user data table.</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/analytics/admin/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const labels = data.map(user => `user ID: ${user.user_id}`);

            // Total Loan Amount Chart
            const totalLoanAmounts = data.map(user => parseFloat(user.total_loan_amount));
            new Chart(document.getElementById('totalLoanAmountChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Amount',
                        data: totalLoanAmounts,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)', /* Red */
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Total Amount Repaid Chart
            const totalAmountsRepaid = data.map(user => parseFloat(user.total_amount_repaid));
            new Chart(document.getElementById('totalAmountRepaidChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Amount',
                        data: totalAmountsRepaid,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)', /* Blue */
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Average Monthly Income Chart
            const averageMonthlyIncomes = data.map(user => parseFloat(user.average_monthly_income));
            new Chart(document.getElementById('averageMonthlyIncomeChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Income',
                        data: averageMonthlyIncomes,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)', /* Green */
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Business Consistency Score Chart
            const businessConsistencyScores = data.map(user => user.business_consistency_score);
            new Chart(document.getElementById('businessConsistencyScoreChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score',
                        data: businessConsistencyScores,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)', /* Purple */
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1.0 // Score is from 0.0 to 1.0
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching user analytics:', error);
            const chartIds = ['totalLoanAmountChart', 'totalAmountRepaidChart', 'averageMonthlyIncomeChart', 'businessConsistencyScoreChart'];
            chartIds.forEach(id => {
                const chartElement = document.getElementById(id);
                if (chartElement) {
                    const chartContainer = chartElement.parentNode.parentNode;
                    chartContainer.innerHTML = '<p>Error loading analytics data. Please ensure you are logged in and the API is accessible.</p>';
                }
            });
        });
    });
</script>
{% endblock %}